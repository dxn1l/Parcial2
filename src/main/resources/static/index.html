<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simulación de Fábrica - Distribución Normal</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
<h1>Simulación de Fábrica - Distribución Normal</h1>

<label for="numEstaciones">Número de estaciones de trabajo:</label>
<input type="number" id="numEstaciones" min="1" max="20" value="10">
<br><br>

<label for="numBolas">Número de bolas:</label>
<input type="number" id="numBolas" min="100" max="10000" value="1000">
<br><br>

<button onclick="startSimulation()">Iniciar Simulación</button>

<h2>Distribución Normal</h2>
<div id="chart"></div>

<script>
    function startSimulation() {
        const numEstaciones = document.getElementById('numEstaciones').value;
        const numBolas = document.getElementById('numBolas').value;

        // Inicia la simulación en el backend
        fetch(`/startSimulation?numBolas=${numBolas}&numEstaciones=${numEstaciones}`)
            .then(response => response.text())
            .then(data => {
                console.log(data); // Mensaje de confirmación en consola

                // Conectar al stream de eventos en tiempo real
                const eventSource = new EventSource(`/simulate/stream?numBolas=${numBolas}`);

                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateChart(data); // Actualiza la gráfica con cada evento recibido
                };

                eventSource.onerror = function() {
                    console.log("Conexión finalizada.");
                    eventSource.close(); // Cierra la conexión al completar la simulación o en caso de error
                };
            });
    }

    function updateChart(data) {
        const chartData = Object.entries(data).map(([key, value]) => ({
            posicion: +key,
            cantidad: +value
        }));

        const width = 500;
        const height = 300;
        const barWidth = width / chartData.length;

        const maxCantidad = d3.max(chartData, d => d.cantidad);

        const svg = d3.select("#chart")
            .html("") // Limpiar contenido previo
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const yScale = d3.scaleLinear()
            .domain([0, maxCantidad])
            .range([height, 0]);

        svg.selectAll("rect")
            .data(chartData)
            .enter()
            .append("rect")
            .attr("x", (d, i) => i * barWidth)
            .attr("y", d => yScale(d.cantidad))
            .attr("width", barWidth - 2)
            .attr("height", d => height - yScale(d.cantidad))
            .attr("fill", "steelblue");

        svg.selectAll("text")
            .data(chartData)
            .enter()
            .append("text")
            .text(d => d.cantidad)
            .attr("x", (d, i) => i * barWidth + (barWidth / 2))
            .attr("y", d => yScale(d.cantidad) - 5)
            .attr("text-anchor", "middle")
            .attr("fill", "black");
    }
</script>

</body>
</html>
