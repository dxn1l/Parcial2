<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simulación de Fábrica - Distribución Normal</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        /* Estilos para el layout y la consola */
        #layout {
            display: flex;
        }
        #chart {
            width: 70%;
        }
        #console {
            width: 30%;
            max-height: 300px;
            overflow-y: auto;
            background-color: #222;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
<h1>Simulación de Fábrica - Distribución Normal</h1>

<label for="numEstaciones">Número de estaciones de trabajo:</label>
<input type="number" id="numEstaciones" min="1" max="20" value="10">
<br><br>

<label for="numBolas">Número de bolas:</label>
<input type="number" id="numBolas" min="100" max="10000" value="1000">
<br><br>

<button onclick="startSimulation()">Iniciar Simulación</button>

<div id="layout">
    <div id="chart"></div>
    <div id="console"></div> <!-- Consola de mensajes -->
</div>

<script>
    function startSimulation() {
        const numEstaciones = document.getElementById('numEstaciones').value;
        const numBolas = document.getElementById('numBolas').value;

        fetch(`/startSimulation?numBolas=${numBolas}&numEstaciones=${numEstaciones}`)
            .then(response => response.text())
            .then(data => {
                console.log(data);

                const eventSource = new EventSource(`/simulate/stream?numBolas=${numBolas}`);

                eventSource.onmessage = function(event) {
                    const receivedData = JSON.parse(event.data);
                    const contenedores = receivedData.contenedores;
                    const mensaje = receivedData.mensaje;

                    // Actualizar el gráfico
                    updateChart(contenedores);

                    // Mostrar el mensaje en la "consola"
                    addConsoleMessage(mensaje);
                };

                eventSource.onerror = function() {
                    console.log("Conexión cerrada");
                    eventSource.close();
                };
            });
    }

    function addConsoleMessage(message) {
        const consoleElement = document.getElementById("console");
        const messageElement = document.createElement("div");
        messageElement.textContent = message;
        consoleElement.appendChild(messageElement);

        // Desplazar hacia abajo automáticamente para mostrar el último mensaje
        consoleElement.scrollTop = consoleElement.scrollHeight;
    }

    function updateChart(contenedores) {
        const chartData = Object.entries(contenedores).map(([key, value]) => ({
            posicion: +key,
            cantidad: +value
        }));

        const width = 500;
        const height = 300;
        const barWidth = width / chartData.length;

        const maxCantidad = d3.max(chartData, d => d.cantidad);

        const svg = d3.select("#chart")
            .html("")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const yScale = d3.scaleLinear()
            .domain([0, maxCantidad])
            .range([height, 0]);

        svg.selectAll("rect")
            .data(chartData)
            .enter()
            .append("rect")
            .attr("x", (d, i) => i * barWidth)
            .attr("y", d => yScale(d.cantidad))
            .attr("width", barWidth - 2)
            .attr("height", d => height - yScale(d.cantidad))
            .attr("fill", "steelblue");

        svg.selectAll("text")
            .data(chartData)
            .enter()
            .append("text")
            .text(d => d.cantidad)
            .attr("x", (d, i) => i * barWidth + (barWidth / 2))
            .attr("y", d => yScale(d.cantidad) - 5)
            .attr("text-anchor", "middle")
            .attr("fill", "black");
    }
</script>

</body>
</html>
